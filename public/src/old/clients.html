<link rel="import" href="/public/bower_components/polymer/polymer.html">

<link rel="import" href="/public/bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="/public/bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="/public/bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="/public/bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="/public/bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="/public/bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="/public/bower_components/neon-animation/animations/slide-from-left-animation.html">

<link rel="import" href="/public/bower_components/app-route/app-location.html">
<link rel="import" href="/public/bower_components/app-route/app-route.html">

<link rel="import" href="/public/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/public/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="/public/bower_components/iron-icons/iron-icons.html">

<link rel="import" href="/public/bower_components/paper-card/paper-card.html">
<link rel="import" href="/public/bower_components/paper-input/paper-input.html">
<link rel="import" href="/public/bower_components/paper-fab/paper-fab.html">
<link rel="import" href="/public/bower_components/paper-ripple/paper-ripple.html">

<link rel="import" href="/public/bower_components/polymerfire/firebase-document.html">
<link rel="import" href="/public/bower_components/polymerfire/firebase-query.html">

<link rel="import" href="./shared-styles.html">

<dom-module id="user-clients">
  <template>
    <style is="custom-style" include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: block;
      }

    </style>

    <app-route
      route="{{route}}"
      pattern="/list"
      active="{{listActive}}">
    </app-route>
    <app-route
      route="{{route}}"
      pattern="/show/:id"
      data="{{showData}}"
      active="{{showActive}}">
    </app-route>
    <app-route
      route="{{route}}"
      pattern="/add"
      active="{{addActive}}">
    </app-route>

    <firebase-query
      id="query"
      app-name="factures"
      path="/users/[[uid]]/clients"
      data="{{clients}}">
    </firebase-query>

    <app-header-layout class="full-height" has-scrolling-region>
      <app-header condenses reveals effects="waterfall">
        <app-toolbar>
          <a id="backButton" href="/homepage"><paper-icon-button icon="arrow-back"></paper-icon-button></a>
          <div title>Mes clients</div>
          <a href="/clients/add"><paper-icon-button id="addClient" icon="add"></paper-icon-button></a>
        </app-toolbar>
      </app-header>

      <neon-animated-pages
        class="full-height"
        entry-animation="slide-from-left-animation"
        exit-animation="fade-out-animation"
        selected="{{selected}}">

        <clients-list class="full-height" clients="{{clients}}">
        </clients-list>
        <client-detail id="detail" edit="{{addActive}}" uid="{{uid}}">
        </client-detail>

      </neon-animated-pages>
    </app-header-layout>

  </template>
  <script>
    Polymer({

      is: 'user-clients',
      properties: {
        uid: {
          type: String
        },
        clients: {
          type: Array,
        },
        route:{
          type: Object,
          observer: '_routeChanged'
        },
        showData: {
          type: Object,
        },
        addActive: {
          type: Boolean,
        },
        showActive: {
          type: Boolean,
        },
        listActive: {
          type: Boolean,
        },
        selected: {
          type: Number,
          value: 0
        },
        clientKey: {
          type: Number
        },
      },

      _routeChanged: function (route) {
        if (route && route.prefix == '/clients'){
          if (this.listActive){
            this.selected = 0;
            this.$.addClient.style.display = "block";
            this.$.backButton.href = "/homepage"
          }
          else if (this.showActive){
            this.$.backButton.href = "/clients/list"
            this.$.detail.setClientKey(this.showData.id);
            this.$.addClient.style.display = "none";
            this.selected = 1;
          }
          else if (this.addActive){
            this.$.backButton.href = "/clients/list"
            this.$.addClient.style.display = "none";
            this.$.detail.setClientKey(this.clients.length);
            this.selected = 1;
          }
        }
      },
    });
  </script>
</dom-module>

<dom-module id="clients-list">
  <template>
    <style is="custom-style" include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: block;
      }
    </style>

    <div class="full-height vertical layout list">
      <template is="dom-repeat" items={{clients}}>
        <client-item class="item" client="{{item}}"></client-item>
      </template>
    </div>

  </template>
  <script>
    Polymer({
      is: 'clients-list',

      properties: {
        clients: {
          type: Array
        }
      }
    });
  </script>
</dom-module>

<dom-module id="client-detail">
  <template>
    <style is="custom-style" include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: block;
      }

      #card-container {
        width: 80%;
      }

      #editableInfoCard, #delete {
        display: none;
      }

    </style>

    <firebase-document
      app-name="factures"
      path="/users/[[uid]]/clients/[[clientKey]]"
      data="{{client}}">
    </firebase-document>

    <div class="full-height vertical layout center">

      <div id="card-container" class="flex horizontal layout center">

        <paper-card class="flex">
            <div class="card-content">
              <div id="infoCard" class="vertical layout">
                <h2>{{client.name}}</h2>
                <p>{{client.email}}</p>
                <p>{{client.address}}</p>
                <p>{{client.phone_number}}</p>
              </div>

              <div id="editableInfoCard" class="vertical layout">
                <paper-input label="Nom" value="{{client.name}}"></paper-input>
                <paper-input label="E-mail" value="{{client.email}}"></paper-input>
                <paper-input label="Adresse" value="{{client.address}}"></paper-input>
                <paper-input label="Téléphone" value="{{client.phone_number}}"></paper-input>
              </div>
            </div>
            <div class="card-actions horizontal layout justified">
              <span id="spacer" class="flex"></span>
              <paper-icon-button id="delete" icon="delete"></paper-icon-button>
              <paper-button on-tap="toggleEdit">{{buttonText}}</paper-button>
            </div>
          </paper-card>

        </div>
    </div>

  </template>

  <script>

    Polymer({

      is: 'client-detail',

      properties: {
        clientKey: {
          type: Number,
          observer: 'keyChanged'
        },
        uid: {
          type: String
        },
        client: {
          type: Object,
        },
        edit: {
          type: Boolean,
          value: false,
          observer: "editChanged"
        },
        buttonText: {
          type: String,
          value: "Modifer"
        }
      },

      setClientKey: function (key){
        this.clientKey = key;
      },

      editChanged: function (edit) {
        if (edit){
          this.$.infoCard.style.display = "none";
          this.$.editableInfoCard.style.display = "flex";
          this.$.spacer.style.display = "none";
          this.$.delete.style.display = "block";
          this.buttonText = "Enregistrer";
        } else {
          this.$.infoCard.style.display = "flex";
          this.$.editableInfoCard.style.display = "none";
          this.$.spacer.style.display = "flex";
          this.$.delete.style.display = "none";
          this.buttonText = "Modifier";
        }
      },

      toggleEdit: function () {
        this.edit = !this.edit;
      }

    });
  </script>
</dom-module>

<dom-module id="client-item">
    <template>
      <style is="custom-style" include="shared-styles iron-flex iron-positioning iron-flex-alignment">
        :host {
          display: block;
        }

        .vertical.layout{
          padding: 10px;
        }

        p{
          margin: 5px 0 0 0;
        }

        a{
          color: black;
          text-decoration: none;
        }

        .little {
          font-size: 14px;
        }
      </style>

      <a  href="/clients/show/{{client.$key}}">
        <div class="vertical layout">
          <p>{{client.name}}</p>
          <div class="little">
            <p>{{client.address}}</p>
            <p>{{client.phone_number}}</p>
          </div>
          <paper-ripple fit></paper-ripple>
        </div>
      </a>

    </template>
    <script>
      Polymer({
        is: 'client-item',

        properties: {
          client: {
            type: Object
          }
        }

      });
    </script>
</dom-module>
