<link rel="import" href="/bower_components/polymer/polymer.html">

<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="/bower_components/iron-input/iron-input.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">

<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="/bower_components/polymerfire/firebase-query.html">

<link rel="import" href="/src/shared-styles.html">

<dom-module id="devis-editor">
  <template>
    <style is="custom-style" include="shared-styles iron-flex iron-positioning iron-flex-alignment">
      :host {
        display: block;
      }

      .devis-layout {
        font-weight: 300;
        padding: 10px;
      }

      .devis-layout paper-card {
        width: 100%;
      }

      .entete {
        margin-bottom: 15px;
      }

      .entete .entreprise-info {
        margin-right: 15px;
      }

      .devis-info p {
        margin: 5px 0px;
      }

      .devis-info {
        margin-bottom: 15px;
      }

      .list .item {
        padding: 10px 5px
      }

      #selectClientDialog {
        padding: 0px 15px;
      }

      @media screen and (max-width: 768px) {
        .horizontal.layout.entete {
          display: inline-block;
        }
        .entreprise-info {
          margin-right: 0px;
          margin-bottom: 15px;
          width: 100%;
          float: left;
        }

        .client-info {
          width: 100%;
          float: left;
        }
      }
    </style>

    <div class="devis-layout">

      <paper-card>

        <div class="card-content vertical layout">
          <!-- Début en-tête -->
          <div class="horizontal layout entete">

            <!-- Informations Entreprise -->
            <div class="entreprise-info">
              <table>
                <tbody>
                  <tr>
                    <td>
                      <h2>{{user.name}}</h2>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      {{user.address}}
                    </td>
                  </tr>
                  <tr>
                    <td>
                      {{user.email}}
                    </td>
                  </tr>
                  <tr>
                    <td>
                      {{user.phone_number}}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="flex"></div>

            <!-- Informations Client -->
            <div class="client-info">
              <table>
                <tbody>
                  <tr>
                    <td>
                      <h2>{{client.name}}</h2>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      {{client.address}}
                    </td>
                  </tr>
                  <tr>
                    <td>
                      {{client.email}}
                    </td>
                  </tr>
                  <tr>
                    <td>
                      {{client.phone_number}}
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <paper-button on-tap="selectClient">Selectionner client</paper-button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <!-- Fin en-tête -->
          </div>

          <!-- Début informations devis -->
          <div class="horizontal layout devis-info">
            <div>
              <paper-input label="Name" value="{{tmpDevis.name}}"></paper-input>
            </div>
            <div class="flex"></div>
            <div class="vertical layout">
              <p>{{tmpDevis.date}}</p>
              <p>{{tmpDevis.hour}}</p>
            </div>
          </div>
          <!-- Fin informations devis -->

          <!-- Début liste articles -->
          <div class="vertical layout articles-list">
            <table>
              <thead>
                <tr>
                  <th>
                    Désignation
                  </th>
                  <th>
                    Quantité
                  </th>
                  <th>
                    Prix
                  </th>
                  <th>
                    Total
                  </th>
                  <th>
                  </th>
                </tr>
              </thead>
              <tbody>
                <template is="dom-repeat" items="{{tmpDevis.articles}}">
                  <tr>
                    <td>
                      <paper-input label="Désignation" value="{{item.des}}"></paper-input>
                    </td>
                    <td>
                      <paper-input label="Quantité" value="{{item.qty}}"></paper-input>
                    </td>
                    <td>
                      <paper-input label="Prix" value="{{item.price}}"></paper-input>
                    </td>
                    <td>
                      <p>{{item.total}}</p>
                    </td>
                    <td>
                      <paper-icon-button icon="delete" on-tap="deleteArticle"></paper-icon-button>
                    </td>
                  </tr>
                </template>
                <tr>
                  <td>
                    <paper-input id="articleDes" label="Désignation" value="{{article.des}}"></paper-input>
                  </td>
                  <td>
                    <paper-input label="Quantité" value="{{article.qty}}"></paper-input>
                  </td>
                  <td>
                    <paper-input label="Prix" on-keydown="addArticle" value="{{article.price}}"></paper-input>
                  </td>
                  <td>
                    <p>{{article.total}}</p>
                  </td>
                  <td>
                    <paper-icon-button icon="cancel" on-tap="cancelArticle"></paper-icon-button>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="horizontal layout end-justified">
              <p>Total: {{tmpDevis.total}} €</p>
            </div>
          </div>
          <!-- Fin liste articles -->

        </div>

        <div class="card-actions horizontal layout justified">
          <paper-button on-tap="delete">Supprimer</paper-button>
          <paper-button on-tap="save">Enregistrer</paper-button>
        </div>

      </paper-card>


      <!-- Liste des clients -->
      <firebase-query
        id="query"
        app-name="factures"
        path="/users/[[uid]]/clients"
        data="{{clients}}">
      </firebase-query>

      <paper-dialog
        id="selectClientDialog">
        <h2>Choisir un client</h2>
        <paper-dialog-scrollable>
          <div class="vertical layout list">
            <template is="dom-repeat" items="{{clients}}">
              <div class="item" on-tap="setClient">
                <p>{{item.name}}</p>
                <paper-ripple fit></paper-ripple>
              </div>
            </template>
          </div>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button dialog-dismiss>Annuler</paper-button>
        </div>
      </paper-dialog>
      <!-- Fin liste clients -->

    </div>

  </template>
  <script>
    Polymer({
      is: 'devis-editor',

      properties: {
        uid: {
          type: String
        },
        user: {
          type: Object
        },
        client: {
          type: Object
        },
        clients: {
          type: Array,
        },
        devis: {
          type: Object
        },
        tmpDevis: {
          type: Object,
        },
        article: {
          type: Object,
          value: function () {
            return {
              des: "",
              qty: "",
              price: "",
              total: 0
            }
          },
        },
        articleItemTest: {
          type: String,
          value: "tmpDevis.articles.#"
        }
      },

      observers: [
        '_changeArticle(article.price, article.qty)',
        '_changeDevisArticle(tmpDevis.articles.*)'
      ],

      initialize: function () {
        this.tmpDevis = {
          name: "Devis n°"+(Number(this.key)+1),
          client_key: "",
          date: this.getDate(),
          hour: this.getHour(),
          total: 0,
          articles: [],
        };
        this.check();
      },

      _changeArticle: function (price, qty) {
        this.set('article.total', price * qty);
      },

      _changeDevisArticle: function (data) {
        if (this.articleItemTest === data.path.substr(0, this.articleItemTest.length)){
          var qty = this.get(data.path.substr(0, data.path.lastIndexOf('.')) + ".qty");
          var price = this.get(data.path.substr(0, data.path.lastIndexOf('.')) + ".price");

          this.set(data.path.substr(0, data.path.lastIndexOf('.')) + ".total", qty * price);
          this.updateTotal();
        }
      },

      updateTotal: function (value) {
        var tmp = 0;
        if (value){
          tmp = this.tmpDevis.total + value;
        }
        else {
          this.tmpDevis.articles.forEach(function (item){
            tmp += item.total;
          });
        }
        this.set('tmpDevis.total', tmp);
      },

      cancelArticle: function () {
        this.article = {};
        this.$.articleDes.focus();
      },

      addArticle: function (e) {
        if (e.keyCode === 13 || e.keyCode === 9){
          this.push('tmpDevis.articles',
          {
            des: this.article.des,
            qty: this.article.qty,
            price: this.article.price,
            total: this.article.total
          });
          this.updateTotal(this.article.total);
          this.article = {};
          this.$.articleDes.focus();
        }
      },

      deleteArticle: function (e) {
        var tmp = [];
        if (this.tmpDevis.articles.length > 0){
          for (var i = this.tmpDevis.articles.length - 1; i >= e.model.index; i--){
            tmp.push(this.tmpDevis.articles[i]);
            this.pop('tmpDevis.articles');
          }
          for (var i = tmp.length - 2; i >= 0; i--){
            this.push('tmpDevis.articles', tmp[i]);
          }
        }
        this.updateTotal();
      },

      selectClient: function () {
        this.$.selectClientDialog.open();
      },

      setClient: function(e) {
        this.tmpDevis.client_key = e.model.item.$key;
        this.client = e.model.item;
        this.$.selectClientDialog.close();
      },

      getDate: function () {
        var d = new Date();
        var day = d.getDate();
        var month = d.getMonth() + 1;
        var year = d.getFullYear();

        if (day < 10){
          day = "0" + day;
        }
        if (month < 10){
          month = "0" + month;
        }
        return day+"/"+month+"/"+year;
      },

      getHour: function () {
        var d = new Date();
        var h = d.getHours();
        var m = d.getMinutes();

        if (h < 10){
          h = "0" + h;
        }
        if (m < 10){
          m = "0" + m;
        }
        return h+":"+m;
      },

      check: function () {
        if (this.devis.total){
          this.set('tmpDevis.total', this.devis.total);
        }
        if (this.devis.articles){
          this.set('tmpDevis.articles', this.devis.articles);
        }
        if (this.devis.name){
          this.set('tmpDevis.name', this.devis.name);
        }
        if (this.devis.client_key){
          this.set('tmpDevis.client_key', this.devis.client_key);
        }
        if (this.devis.date){
          this.set('tmpDevis.date', this.devis.date);
        }
        if (this.devis.hour){
          this.set('tmpDevis.hour', this.devis.hour);
        }
      },

      save: function() {
        this.set('devis.name', this.tmpDevis.name);
        this.set('devis.date', this.tmpDevis.date);
        this.set('devis.hour', this.tmpDevis.hour);
        this.set('devis.client_key', this.tmpDevis.client_key);
        this.set('devis.articles', this.tmpDevis.articles);
        this.set('devis.total', this.tmpDevis.total);
      },

      delete: function () {
        this.fire('delete');
      },

      test: function () {
        console.log(this.tmpDevis);
        console.log(this.article);
      }
    });
  </script>
</dom-module>
